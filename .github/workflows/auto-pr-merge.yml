name: Auto PR and Merge

on:
  push:
    branches:
      - dev

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: master
          branch: dev
          title: 'Auto PR from dev to master'
          body: |
            This is an automated pull request generated by GitHub Actions.
            Merging `dev` into `master`.

  merge-pr:
    needs: create-pr
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Merge Pull Request
        id: merge_pr
        uses: actions/github-script@v6
        with:
          script: |
            const { Octokit } = require("@octokit/rest");
            const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
            
            // Get the PR created in the previous step
            const pr = await octokit.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: 'dev'
            });
            
            if (pr.data.length === 0) {
              console.log('No open PR found for dev -> master');
              return;
            }
            
            // Merge the PR
            await octokit.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.data[0].number
            });
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
